rules_version = "2";
service cloud.firestore {
  match /databases/{database}/documents {
    
    function isAuthenticated() {
      return request.auth != null;
    }
    
    match /rides/{rideId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() && request.resource.data.driverId == request.auth.uid;
      allow update: if isAuthenticated() && resource.data.driverId == request.auth.uid;
      allow delete: if isAuthenticated() && resource.data.driverId == request.auth.uid;
    }
    
    match /ride_requests/{requestId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() && request.resource.data.passengerId == request.auth.uid && request.resource.data.rideId != null;
      allow update: if isAuthenticated() && ((resource.data.rideId != null && exists(/databases/$(database)/documents/rides/$(resource.data.rideId)) && get(/databases/$(database)/documents/rides/$(resource.data.rideId)).data.driverId == request.auth.uid) || resource.data.passengerId == request.auth.uid);
      allow delete: if isAuthenticated() && (resource.data.passengerId == request.auth.uid || (resource.data.rideId != null && exists(/databases/$(database)/documents/rides/$(resource.data.rideId)) && get(/databases/$(database)/documents/rides/$(resource.data.rideId)).data.driverId == request.auth.uid));
    }
    
    // NOTA: chat_messages agora usa Realtime Database para melhor performance em tempo real
    
    match /vehicles/{vehicleId} {
      allow read: if isAuthenticated() && resource.data.ownerId == request.auth.uid;
      allow create: if isAuthenticated() && request.resource.data.ownerId == request.auth.uid;
      allow update: if isAuthenticated() && resource.data.ownerId == request.auth.uid;
      allow delete: if isAuthenticated() && resource.data.ownerId == request.auth.uid;
    }
    
    match /auth_tokens/{tokenId} {
      allow read: if isAuthenticated();
      allow write: if false;
    }
    
    // Tokens de ativação e reset de senha
    // Permite criar e ler tokens sem autenticação (necessário para ativação e reset de senha)
    // O token em si não é informação sensível crítica (apenas um número de 6 dígitos)
    match /activationTokens/{tokenId} {
      allow create: if true; // Permite criar tokens sem autenticação
      allow read: if true; // Permite ler para verificar unicidade e validar tokens
      allow update: if resource.data.isUsed != true && request.resource.data.isUsed == true; // Permite atualizar apenas para marcar como usado (uma vez)
      allow delete: if true; // Permite deletar após uso (para limpeza)
    }
    
    match /users/{userId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() && userId == request.auth.uid;
      allow update: if isAuthenticated() && userId == request.auth.uid;
      allow delete: if isAuthenticated() && userId == request.auth.uid;
    }
  }
}
